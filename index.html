<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratorio de Navegación Modal</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s ease, color 0.3s ease; }
        .orbit-node { transition: all 0.3s ease; }
        .orbit-node:hover { transform: scale(1.25); z-index: 50; }
        
        /* Animaciones */
        @keyframes pulse-slow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.15; }
        }
        .animate-pulse-slow { animation: pulse-slow 3s infinite; }

        /* Scrollbar */
        ::-webkit-scrollbar { height: 8px; width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="flex flex-col min-h-screen p-2 md:p-6 bg-slate-50 text-slate-900 dark:bg-[#0f172a] dark:text-e2e8f0 transition-colors duration-300">

    <div class="max-w-7xl mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-6 mb-8">
        
        <!-- HEADER -->
        <div class="lg:col-span-12 flex flex-col md:flex-row justify-between items-end border-b border-slate-200 dark:border-slate-800 pb-6 transition-colors duration-300">
            <div class="flex items-center gap-4">
                <div>
                    <h1 class="text-3xl font-black bg-gradient-to-r from-amber-500 via-orange-500 to-rose-500 dark:from-amber-200 dark:via-orange-300 dark:to-rose-400 bg-clip-text text-transparent uppercase tracking-tighter">
                        Laboratorio de Navegación Modal
                    </h1>
                </div>
                <!-- Theme Toggle Button -->
                <button id="theme-toggle" class="p-2 rounded-full bg-slate-200 text-slate-600 hover:bg-slate-300 dark:bg-slate-800 dark:text-slate-400 dark:hover:bg-slate-700 transition-all shadow-sm" title="Cambiar Tema">
                    <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
                    <i data-lucide="sun" class="w-5 h-5 block dark:hidden"></i>
                </button>
            </div>
            
            <div class="flex gap-4 mt-4 md:mt-0 w-full md:w-auto items-end">
                <div class="flex flex-col flex-1 min-w-[120px]">
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-[10px] uppercase font-bold text-slate-500">Tónica</label>
                        <button id="header-enharmonic-btn" class="hidden text-[10px] text-blue-600 dark:text-blue-400 hover:text-blue-500 dark:hover:text-blue-300 flex items-center gap-1 bg-blue-100 dark:bg-blue-900/30 px-1.5 rounded border border-blue-200 dark:border-blue-500/30 transition-colors">
                            <i data-lucide="refresh-cw" class="w-3 h-3"></i> Enarmónico
                        </button>
                    </div>
                    <select id="root-select" class="bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded p-2 text-sm focus:ring-2 focus:ring-amber-500 outline-none w-full text-slate-900 dark:text-white shadow-sm transition-colors">
                        <!-- Options generated by JS -->
                    </select>
                </div>
                <div class="flex flex-col flex-[2]">
                    <label class="text-[10px] uppercase font-bold text-slate-500 mb-1">Modo Base</label>
                    <select id="mode-select" class="bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded p-2 text-sm focus:ring-2 focus:ring-amber-500 outline-none text-slate-900 dark:text-white shadow-sm transition-colors">
                        <!-- Options generated by JS -->
                    </select>
                </div>
            </div>
        </div>

        <!-- MAPA VISUAL -->
        <div class="lg:col-span-8 h-[500px] lg:h-[600px] relative bg-slate-100 dark:bg-slate-900/50 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-xl dark:shadow-2xl overflow-hidden select-none transition-colors duration-300" id="visual-map-container">
            <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-slate-200/50 via-slate-100/0 to-slate-200/80 dark:from-slate-800/30 dark:via-slate-900/0 dark:to-slate-950/80 transition-colors duration-300"></div>
            
            <!-- Anillos -->
            <div class="absolute inset-0 flex items-center justify-center opacity-30 pointer-events-none">
                <div class="w-[25%] h-[25%] rounded-full border border-amber-500/50"></div>
                <div class="w-[55%] h-[55%] rounded-full border border-blue-400/30"></div>
                <div class="w-[85%] h-[85%] rounded-full border border-slate-600/30"></div>
            </div>

            <div class="absolute top-4 left-4 text-[10px] font-mono text-slate-500 dark:text-slate-600 space-y-1 z-10">
                <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-amber-500"></div>Relativos</div>
                <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-blue-500"></div>Cercanos</div>
                <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-slate-400 dark:bg-slate-500"></div>Lejanos</div>
            </div>

            <!-- NODO CENTRAL (HOME) -->
            <div id="home-node-container" class="absolute inset-0 flex items-center justify-center z-20 pointer-events-none">
                <!-- Injected via JS -->
            </div>

            <!-- ORBIT SYSTEM -->
            <div id="orbit-system">
                <!-- Nodes injected via JS -->
            </div>
        </div>

        <!-- INSPECTOR LATERAL -->
        <div class="lg:col-span-4 flex flex-col gap-4">
            <div class="bg-white dark:bg-slate-800 rounded-2xl p-5 border border-slate-200 dark:border-slate-700 shadow-lg flex-1 flex flex-col relative transition-colors duration-300">
                <h2 class="text-xs font-bold uppercase text-slate-400 flex items-center gap-2 mb-4">
                    <i data-lucide="info" class="w-4 h-4"></i> Inspector
                </h2>

                <div id="inspector-content" class="flex-1 flex flex-col">
                    <!-- Default State -->
                    <div class="h-full flex flex-col items-center justify-center text-slate-400 dark:text-slate-600 opacity-60">
                        <i data-lucide="grid" class="w-12 h-12 mb-2"></i>
                        <p class="text-sm">Selecciona un nodo</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- PROGRESSION BUILDER -->
        <div class="lg:col-span-12 bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 p-6 shadow-lg transition-colors duration-300">
            <div class="flex items-center justify-between mb-4 border-b border-slate-100 dark:border-slate-800 pb-2">
                <h2 class="text-sm font-bold uppercase text-slate-400 flex items-center gap-2">
                    <i data-lucide="map-pin" class="w-4 h-4 text-green-500"></i> Mi Progresión / Ruta Modal
                </h2>
                <div class="flex items-center gap-3">
                    <div id="progression-count" class="text-xs text-slate-500">0 Pasos</div>
                    <button id="clear-progression-btn" class="hidden text-xs text-slate-500 hover:text-red-400 flex items-center gap-1 transition-all">
                        <i data-lucide="trash-2" class="w-3 h-3"></i> <span id="clear-btn-text">Borrar Todo</span>
                    </button>
                </div>
            </div>

            <div id="progression-container" class="flex gap-4 overflow-x-auto pb-4">
                <!-- Empty State -->
                <div class="w-full text-center py-8 text-slate-400 dark:text-slate-600 border-2 border-dashed border-slate-200 dark:border-slate-800 rounded-xl">
                    <p class="text-sm">No has agregado acordes aún.</p>
                    <p class="text-xs mt-1">Usa el botón "+" en el centro o en el inspector.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- DATA & CONFIG ---
        const NOTES_SHARP = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const NOTES_FLAT = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
        const ROOT_OPTIONS = ['C', 'C#', 'Db', 'D', 'Eb', 'E', 'F', 'F#', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];

        const ENHARMONIC_MAP = {
            'C#': 'Db', 'Db': 'C#', 'D#': 'Eb', 'Eb': 'D#', 'F#': 'Gb', 'Gb': 'F#',
            'G#': 'Ab', 'Ab': 'G#', 'A#': 'Bb', 'Bb': 'A#', 'B': 'Cb', 'Cb': 'B',
            'E': 'Fb', 'Fb': 'E', 'E#': 'F', 'F': 'E#', 'B#': 'C', 'C': 'B#'
        };

        // Theme Definitions (Adjusted for Light/Dark modes)
        // using tailwind classes: text-color-600 for light mode contrast, text-color-400 for dark mode
        const FAMILY_THEMES = {
            "Escala Mayor": { 
                color: "text-amber-600 dark:text-amber-400", 
                bg: "bg-amber-500", 
                border: "border-amber-500", 
                glow: "shadow-amber-500/50", 
                gradient: "from-amber-100 to-amber-50 dark:from-amber-500/20 dark:to-amber-900/5",
                softBorder: "border-amber-200 dark:border-amber-500/30",
                softBg: "bg-amber-50 dark:bg-amber-900/10"
            },
            "Menor Armónica": { 
                color: "text-rose-600 dark:text-rose-400", 
                bg: "bg-rose-500", 
                border: "border-rose-500", 
                glow: "shadow-rose-500/50", 
                gradient: "from-rose-100 to-rose-50 dark:from-rose-500/20 dark:to-rose-900/5",
                softBorder: "border-rose-200 dark:border-rose-500/30",
                softBg: "bg-rose-50 dark:bg-rose-900/10"
            },
            "Menor Melódica": { 
                color: "text-emerald-600 dark:text-emerald-400", 
                bg: "bg-emerald-500", 
                border: "border-emerald-500", 
                glow: "shadow-emerald-500/50", 
                gradient: "from-emerald-100 to-emerald-50 dark:from-emerald-500/20 dark:to-emerald-900/5",
                softBorder: "border-emerald-200 dark:border-emerald-500/30",
                softBg: "bg-emerald-50 dark:bg-emerald-900/10"
            },
            "Mayor Armónica": { 
                color: "text-violet-600 dark:text-violet-400", 
                bg: "bg-violet-500", 
                border: "border-violet-500", 
                glow: "shadow-violet-500/50", 
                gradient: "from-violet-100 to-violet-50 dark:from-violet-500/20 dark:to-violet-900/5",
                softBorder: "border-violet-200 dark:border-violet-500/30",
                softBg: "bg-violet-50 dark:bg-violet-900/10"
            }
        };

        const MODES_DATA = {
            "Escala Mayor": { "Jónico (Mayor)": [0,2,4,5,7,9,11], "Dórico": [0,2,3,5,7,9,10], "Frigio": [0,1,3,5,7,8,10], "Lidio": [0,2,4,6,7,9,11], "Mixolidio": [0,2,4,5,7,9,10], "Eólico (Menor)": [0,2,3,5,7,8,10], "Locrio": [0,1,3,5,6,8,10] },
            "Menor Armónica": { "Menor Armónica": [0,2,3,5,7,8,11], "Locrio ♮6": [0,1,3,5,6,9,10], "Jónico #5": [0,2,4,5,8,9,11], "Dórico #4": [0,2,3,6,7,9,10], "Mixolidio b9 b13": [0,1,4,5,7,8,10], "Lidio #2": [0,3,4,6,7,9,11], "Locrio b4 bb7": [0,1,3,4,6,8,9] },
            "Menor Melódica": { "Menor Melódica": [0,2,3,5,7,9,11], "Frigio ♮6 (Dórico b2)": [0,1,3,5,7,9,10], "Lidio Aumentado": [0,2,4,6,8,9,11], "Mixolidio #4 (Lidio b7)": [0,2,4,6,7,9,10], "Mixolidio b6": [0,2,4,5,7,8,10], "Locrio ♮2": [0,2,3,5,6,8,10], "Alterada (Super Locrio)": [0,1,3,4,6,8,10] },
            "Mayor Armónica": { "Jónico b6": [0,2,4,5,7,8,11], "Locrio ♮2 (Dórico b5)": [0,2,3,5,6,9,10], "Frigio b4": [0,1,3,4,7,8,10], "Lidio b3 (Dórico #4)": [0,2,3,6,7,9,11], "Mixolidio b2": [0,1,4,5,7,9,10], "Lidio Aumentado #2": [0,3,4,6,8,9,11], "Locrio bb7": [0,1,3,5,6,8,9] }
        };

        let ALL_MODES_FLAT = {};
        Object.keys(MODES_DATA).forEach(family => {
            Object.keys(MODES_DATA[family]).forEach((mode, idx, arr) => {
                ALL_MODES_FLAT[mode] = { family, intervals: MODES_DATA[family][mode], degree: idx + 1, degreeTotal: arr.length };
            });
        });

        // --- STATE ---
        let state = {
            root: 'C',
            mode: 'Jónico (Mayor)',
            hoveredNode: null,
            progression: [],
            clearConfirm: false,
            // Dark mode is handled by HTML class "dark"
        };

        let audioCtx = null;

        // --- AUDIO ENGINE ---
        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playChord(root, intervals, type = 'chord') {
            initAudio();
            const rootIdx = getNoteIndex(root);
            const baseFreq = 130.81 * Math.pow(2, rootIdx / 12); 
            const now = audioCtx.currentTime;
            const indices = [0, 2, 4, 6]; 
            
            if (type === 'chord') {
                indices.forEach((degreeIdx, i) => {
                    if (degreeIdx >= intervals.length) return;
                    playTone(baseFreq, intervals[degreeIdx], now, 1.5, i === 0 ? 'triangle' : 'sine');
                });
            } else if (type === 'scale') {
                intervals.forEach((interval, i) => {
                    playTone(baseFreq, interval, now + (i * 0.2), 0.3, 'sine');
                });
                playTone(baseFreq, 12, now + (intervals.length * 0.2), 0.8, 'sine');
            }
        }

        function playTone(baseFreq, semitones, startTime, duration, type) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.value = baseFreq * Math.pow(2, semitones / 12);
            osc.type = type;
            
            gain.gain.setValueAtTime(0, startTime);
            gain.gain.linearRampToValueAtTime(0.1, startTime + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(startTime);
            osc.stop(startTime + duration);
        }

        // --- THEORY UTILS ---
        function getNoteIndex(noteName) {
            let idx = NOTES_SHARP.indexOf(noteName);
            if (idx === -1) idx = NOTES_FLAT.indexOf(noteName);
            return idx;
        }

        function getScaleNotesIndices(rootIndex, intervals) {
            return intervals.map(interval => (rootIndex + interval) % 12);
        }

        function getStrictScaleDetails(rootNote, intervals) {
            const ALPHABET = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            const NATURALS = { 'C':0, 'D':2, 'E':4, 'F':5, 'G':7, 'A':9, 'B':11 };
            
            let rootLetter = rootNote.charAt(0);
            let rootVal = getNoteIndex(rootNote);
            let notes = [], formula = [];
            let rootLetterIdx = ALPHABET.indexOf(rootLetter);

            intervals.forEach((interval, i) => {
                const targetLetter = ALPHABET[(rootLetterIdx + i) % 7];
                let naturalDist = NATURALS[targetLetter]; 
                let targetVal = (rootVal + interval) % 12;
                let diff = targetVal - naturalDist;
                if (diff > 6) diff -= 12;
                if (diff < -6) diff += 12;

                let acc = '';
                if (diff === 1) acc = '#';
                else if (diff === 2) acc = '##';
                else if (diff === -1) acc = 'b';
                else if (diff === -2) acc = 'bb';
                
                notes.push(targetLetter + acc);

                const major = [0,2,4,5,7,9,11];
                let fDiff = interval - major[i];
                let fSym = (i + 1).toString();
                if (i===0) fSym = '1';
                else if (fDiff === 1) fSym = '#' + fSym;
                else if (fDiff === -1) fSym = 'b' + fSym;
                else if (fDiff === -2) fSym = 'bb' + fSym;
                formula.push(fSym);
            });
            return { notes, formula };
        }

        function getChordSymbol(root, intervals) {
            const i = new Set(intervals);
            let s = root;
            if (i.has(4)) { 
                if (i.has(7)) { if (i.has(11)) s += "maj7"; else if (i.has(10)) s += "7"; }
                else if (i.has(8)) { if (i.has(11)) s += "maj7#5"; else if (i.has(10)) s += "7#5"; else s += "aug"; }
                else if (i.has(6)) s += i.has(10) ? "7b5" : "maj7b5";
            } else if (i.has(3)) { 
                if (i.has(7)) { if (i.has(11)) s += "mMaj7"; else if (i.has(10)) s += "m7"; else s += "m"; }
                else if (i.has(6)) { if (i.has(9)) s += "dim7"; else if (i.has(10)) s += "m7b5"; else s += "dim"; }
            } else { 
                if (i.has(7)) s += i.has(5) ? "sus4" : (i.has(2) ? "sus2" : "5"); else s += "(no3)";
            }
            return s;
        }

        function analyzeRelationship(homeIndices, targetIndices) {
            const setHome = new Set(homeIndices);
            let diff = 0, diffIndices = [];
            targetIndices.forEach(n => { if(!setHome.has(n)) { diff++; diffIndices.push(n); }});
            
            let hasTetra = false;
            const ext = [...targetIndices, ...targetIndices.slice(0,3)];
            for(let i=0; i<targetIndices.length; i++) {
                if([0,1,2,3].every(x => setHome.has(ext[i+x]))) { hasTetra = true; break; }
            }
            return { diff, diffIndices, hasTetra };
        }

        // --- RENDER LOGIC ---

        function init() {
            const rSel = document.getElementById('root-select');
            ROOT_OPTIONS.forEach(r => { let opt = document.createElement('option'); opt.value = r; opt.innerText = r; rSel.appendChild(opt); });

            const mSel = document.getElementById('mode-select');
            Object.keys(MODES_DATA).forEach(family => {
                let grp = document.createElement('optgroup'); grp.label = family;
                Object.keys(MODES_DATA[family]).forEach(m => { let opt = document.createElement('option'); opt.value = m; opt.innerText = m; grp.appendChild(opt); });
                mSel.appendChild(grp);
            });

            rSel.addEventListener('change', e => { state.root = e.target.value; update(); });
            mSel.addEventListener('change', e => { state.mode = e.target.value; update(); });
            
            document.getElementById('header-enharmonic-btn').addEventListener('click', toggleEnharmonicHeader);
            document.getElementById('clear-progression-btn').addEventListener('click', clearProgression);
            
            // Theme Toggle
            document.getElementById('theme-toggle').addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                // Re-render map to update static Tailwind classes in JS if needed (not needed for basic dark: classes but good for cleanliness)
                // Actually Lucide icons need re-scan on theme change sometimes
                setTimeout(() => lucide.createIcons(), 100);
            });
            
            document.body.addEventListener('click', initAudio, { once: true });

            update();
            lucide.createIcons();
        }

        function toggleEnharmonicHeader() {
            const eq = ENHARMONIC_MAP[state.root];
            if(eq) { state.root = eq; document.getElementById('root-select').value = eq; update(); }
        }

        function toggleEnharmonicInspector() {
            if (!state.hoveredNode) return;
            const eq = ENHARMONIC_MAP[state.hoveredNode.root];
            if (eq) {
                const newNode = { ...state.hoveredNode, root: eq };
                newNode.chord = getChordSymbol(eq, newNode.intervals);
                state.hoveredNode = newNode;
                renderInspector();
            }
        }

        function update() {
            const rootIdx = getNoteIndex(state.root);
            const homeMode = ALL_MODES_FLAT[state.mode];
            const homeIndices = getScaleNotesIndices(rootIdx, homeMode.intervals);
            const homeDetails = getStrictScaleDetails(state.root, homeMode.intervals);
            const homeChord = getChordSymbol(state.root, homeMode.intervals);
            const homeData = { ...homeMode, root: state.root, mode: state.mode, indices: homeIndices, notes: homeDetails.notes, formula: homeDetails.formula, chord: homeChord };

            let layers = { relatives: [], close: [], distant: [] };
            
            NOTES_SHARP.forEach((r, rIdx) => {
                Object.keys(ALL_MODES_FLAT).forEach(mName => {
                    if (r === state.root && mName === state.mode) return;
                    
                    const mData = ALL_MODES_FLAT[mName];
                    const tIndices = getScaleNotesIndices(rIdx, mData.intervals);
                    const rel = analyzeRelationship(homeIndices, tIndices);
                    const tChord = getChordSymbol(r, mData.intervals);

                    const node = {
                        root: r, mode: mName, family: mData.family, degree: mData.degree,
                        indices: tIndices, diff: rel.diff, diffIndices: rel.diffIndices, hasTetra: rel.hasTetra,
                        chord: tChord, intervals: mData.intervals
                    };

                    if(rel.diff === 0) layers.relatives.push(node);
                    else if(rel.diff === 1) layers.close.push(node);
                    else if(rel.diff === 2) layers.distant.push(node);
                });
            });

            renderMap(homeData, layers);
            renderInspector();

            const btnHeader = document.getElementById('header-enharmonic-btn');
            if(ENHARMONIC_MAP[state.root]) {
                btnHeader.classList.remove('hidden');
                btnHeader.title = `Cambiar a ${ENHARMONIC_MAP[state.root]}`;
            } else {
                btnHeader.classList.add('hidden');
            }
        }

        function renderMap(homeData, layers) {
            const container = document.getElementById('home-node-container');
            const theme = FAMILY_THEMES[homeData.family];
            
            container.innerHTML = `
                <div class="relative group">
                    <div class="w-40 h-40 rounded-full bg-white dark:bg-slate-950 border-4 ${theme.border} ${theme.glow} flex flex-col items-center justify-center text-center p-2 z-10 pointer-events-auto cursor-default shadow-xl transition-all duration-500">
                        <span class="text-[10px] font-black tracking-widest text-slate-400 dark:text-slate-500 mb-0.5 border-b border-slate-200 dark:border-slate-800 pb-0.5">${homeData.degree}º MODO</span>
                        <span class="text-3xl font-black text-slate-900 dark:text-white tracking-tighter mb-0.5">${homeData.chord}</span>
                        <span class="text-[9px] font-bold ${theme.color} uppercase leading-tight max-w-[90%]">${state.mode}</span>
                    </div>
                    <div class="absolute -bottom-5 left-1/2 -translate-x-1/2 flex gap-2 pointer-events-auto z-30">
                        <button onclick="addHomeToProgression()" class="bg-green-600 hover:bg-green-500 text-white rounded-full p-2 shadow-lg border-4 border-white dark:border-slate-900 transition-transform hover:scale-110"><i data-lucide="plus" class="w-5 h-5"></i></button>
                        <button onclick="playHome()" class="bg-slate-700 hover:bg-slate-600 text-white rounded-full p-2 shadow-lg border-4 border-white dark:border-slate-900 transition-transform hover:scale-110"><i data-lucide="volume-2" class="w-5 h-5"></i></button>
                    </div>
                </div>
            `;
            
            const orbitSys = document.getElementById('orbit-system');
            orbitSys.innerHTML = '';
            
            const appendLayer = (nodes, rPerc, bg, size, showText) => {
                // Limit visualization to prevent clutter
                const limit = showText ? 12 : (size === '20px' ? 16 : 24);
                const sliced = nodes.slice(0, limit);
                sliced.forEach((n, i) => {
                    const angle = (i / sliced.length) * 2 * Math.PI - (Math.PI / 2);
                    const left = 50 + (rPerc/2 * Math.cos(angle));
                    const top = 50 + (rPerc/2 * Math.sin(angle));
                    
                    const btn = document.createElement('button');
                    // Dynamic Orbit Colors for Light/Dark
                    // Close/Relatives need actual colors, Distant can be gray
                    // Note: Passed 'bg' arg is specific to layer, but we need dual mode classes now.
                    // We'll override the passed bg argument with specific theme-aware classes
                    let dynamicBg = '';
                    if (rPerc === 85) dynamicBg = 'bg-slate-300 border-slate-400 hover:bg-slate-400 dark:bg-slate-700 dark:border-slate-600 dark:hover:bg-slate-500'; // Distant
                    else if (rPerc === 55) dynamicBg = 'bg-blue-300 border-blue-400 hover:bg-blue-400 dark:bg-blue-600 dark:border-blue-800 dark:hover:bg-blue-400'; // Close
                    else dynamicBg = 'bg-amber-300 border-amber-400 hover:bg-amber-400 dark:bg-amber-500 dark:border-amber-300 dark:hover:bg-amber-400'; // Relative

                    btn.className = `absolute rounded-full border shadow-lg flex items-center justify-center transition-all duration-300 hover:scale-150 hover:z-50 cursor-pointer group ${dynamicBg} orbit-node`;
                    btn.style.left = `${left}%`; btn.style.top = `${top}%`;
                    btn.style.width = size; btn.style.height = size;
                    btn.style.marginLeft = `calc(-${size} / 2)`; btn.style.marginTop = `calc(-${size} / 2)`;
                    
                    if (showText) btn.innerHTML = `<span class="text-[9px] font-bold text-slate-800 dark:text-slate-900">${n.root}</span>`;
                    
                    btn.onmouseenter = () => { state.hoveredNode = n; renderInspector(); };
                    btn.onclick = () => { state.root = n.root; state.mode = n.mode; state.hoveredNode = null; update(); };

                    orbitSys.appendChild(btn);
                });
            };

            appendLayer(layers.distant, 85, null, '12px', false);
            appendLayer(layers.close, 55, null, '20px', false);
            appendLayer(layers.relatives, 25, null, '32px', true);
        }

        function renderInspector() {
            const container = document.getElementById('inspector-content');
            const node = state.hoveredNode;
            
            if (!node) {
                container.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center text-slate-400 dark:text-slate-600 opacity-60">
                        <i data-lucide="grid" class="w-12 h-12 mb-2"></i>
                        <p class="text-sm">Selecciona un nodo</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            const theme = FAMILY_THEMES[node.family] || FAMILY_THEMES["Escala Mayor"];
            const details = getStrictScaleDetails(node.root, node.intervals);
            const hasEnharmonic = !!ENHARMONIC_MAP[node.root];

            let notesHTML = '';
            details.notes.forEach((n, i) => {
                const isDiff = node.diffIndices.includes(node.indices[i]);
                const style = isDiff 
                    ? 'bg-red-50 border-red-200 text-red-600 dark:bg-red-900/20 dark:border-red-500/50 dark:text-red-400' 
                    : 'bg-slate-100 border-slate-200 text-slate-600 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300';
                notesHTML += `
                    <div class="flex flex-col items-center">
                        <span class="w-8 h-8 flex items-center justify-center rounded-lg font-bold border text-sm transition-colors ${style}">${n}</span>
                        <span class="text-[9px] text-slate-400 dark:text-slate-600 mt-1 font-mono">${details.formula[i]}</span>
                    </div>`;
            });

            container.innerHTML = `
                <div class="mb-4 text-center p-4 bg-gradient-to-br ${theme.gradient} rounded-xl border ${theme.border} relative overflow-hidden shadow-sm">
                    <div class="absolute top-2 right-3 text-[9px] font-bold px-2 py-0.5 bg-white/60 dark:bg-slate-900/50 ${theme.color} rounded-full border border-slate-200 dark:border-slate-700">
                        ${node.degree}º MODO
                    </div>
                    
                    ${hasEnharmonic ? `
                    <button onclick="toggleEnharmonicInspector()" class="absolute top-2 left-2 p-1 rounded hover:bg-black/10 dark:hover:bg-white/10 text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white transition-colors" title="Ver Enarmónico">
                         <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                    </button>` : ''}

                    <div class="text-xs uppercase text-slate-500 dark:text-slate-300 opacity-70 mb-1 mt-2">Acorde Resultante</div>
                    <div class="text-4xl font-black text-slate-900 dark:text-white drop-shadow-sm mb-2">${node.chord}</div>
                    
                    <div class="flex justify-center gap-2 mt-2">
                        <button onclick="playInspector('chord')" class="flex items-center gap-1 text-[10px] bg-black/5 dark:bg-white/10 hover:bg-black/10 dark:hover:bg-white/20 px-2 py-1 rounded text-slate-700 dark:text-white transition-colors">
                            <i data-lucide="volume-2" class="w-3 h-3"></i> Acorde
                        </button>
                        <button onclick="playInspector('scale')" class="flex items-center gap-1 text-[10px] bg-black/5 dark:bg-white/10 hover:bg-black/10 dark:hover:bg-white/20 px-2 py-1 rounded text-slate-700 dark:text-white transition-colors">
                            <i data-lucide="music" class="w-3 h-3"></i> Escala
                        </button>
                    </div>
                </div>

                <div class="mb-2">
                    <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200 leading-tight">${node.root} <span class="font-normal text-slate-500 dark:text-slate-400">${node.mode}</span></h3>
                    <div class="flex items-center gap-2 mt-1">
                        <i data-lucide="layers" class="w-3 h-3 ${theme.color}"></i>
                        <p class="text-xs ${theme.color} font-medium">${node.family}</p>
                    </div>
                </div>

                <div class="bg-slate-50 dark:bg-slate-950 rounded-lg p-3 border border-slate-200 dark:border-slate-800 mb-4 mt-2">
                    <div class="flex flex-wrap gap-1 mb-2 justify-center">${notesHTML}</div>
                </div>

                <div class="p-3 rounded-lg border flex items-start gap-3 mb-4 ${node.hasTetra ? 'bg-emerald-50 dark:bg-emerald-900/10 border-emerald-200 dark:border-emerald-500/20' : 'bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700'}">
                    <i data-lucide="${node.hasTetra ? 'check' : 'x'}" class="w-4 h-4 ${node.hasTetra ? 'text-emerald-600 dark:text-emerald-500' : 'text-slate-400 dark:text-slate-500'} mt-0.5"></i>
                    <div>
                        <h4 class="text-xs font-bold ${node.hasTetra ? 'text-emerald-700 dark:text-emerald-500' : 'text-slate-500'}">
                            ${node.hasTetra ? 'Conexión Fluida (Tetracordio)' : 'Sin conexión directa'}
                        </h4>
                    </div>
                </div>

                <div class="mt-auto grid grid-cols-2 gap-2">
                    <button onclick="addInspectorToProgression()" class="py-3 bg-slate-200 dark:bg-slate-700 hover:bg-green-500 dark:hover:bg-green-600 text-slate-700 dark:text-slate-200 hover:text-white dark:hover:text-white font-bold rounded-lg transition-colors flex items-center justify-center gap-2 text-xs uppercase tracking-wide">
                        <i data-lucide="plus" class="w-4 h-4"></i> Agregar
                    </button>
                    <button onclick="goToInspector()" class="py-3 bg-slate-200 dark:bg-slate-700 hover:bg-amber-500 dark:hover:bg-amber-600 text-slate-700 dark:text-slate-200 hover:text-white dark:hover:text-white font-bold rounded-lg transition-colors flex items-center justify-center gap-2 text-xs uppercase tracking-wide">
                        Ir Aquí <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
            lucide.createIcons();
        }

        // --- PROGRESSION LOGIC ---
        function renderProgression() {
            const container = document.getElementById('progression-container');
            const countEl = document.getElementById('progression-count');
            const clearBtn = document.getElementById('clear-progression-btn');
            
            countEl.innerText = `${state.progression.length} Pasos`;
            
            if (state.progression.length > 0) {
                clearBtn.classList.remove('hidden');
                document.getElementById('clear-btn-text').innerText = state.clearConfirm ? "¿Confirmar?" : "Borrar Todo";
                clearBtn.className = state.clearConfirm 
                    ? "text-xs text-red-600 dark:text-red-400 font-bold bg-red-100 dark:bg-red-900/20 px-2 py-0.5 rounded flex items-center gap-1 transition-all"
                    : "text-xs text-slate-500 hover:text-red-500 dark:hover:text-red-400 flex items-center gap-1 transition-all";
                
                container.innerHTML = '';
                state.progression.forEach((item, idx) => {
                    const theme = FAMILY_THEMES[item.family] || FAMILY_THEMES["Escala Mayor"];
                    const div = document.createElement('div');
                    div.className = `min-w-[220px] bg-white dark:bg-slate-800 rounded-xl p-4 border-l-4 ${theme.border} relative group flex-shrink-0 shadow-md dark:shadow-lg`;
                    
                    let notesHTML = '';
                    item.notes.forEach(n => {
                        notesHTML += `<span class="text-[9px] font-mono bg-slate-100 dark:bg-slate-900 px-1 rounded text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">${n}</span>`;
                    });

                    div.innerHTML = `
                        <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="playProgressionItem(${item.id})" class="p-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded text-slate-400 hover:text-slate-800 dark:hover:text-white"><i data-lucide="volume-2" class="w-3.5 h-3.5"></i></button>
                            <button onclick="removeProgressionItem(${item.id})" class="p-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded text-slate-400 hover:text-red-500 dark:hover:text-red-400"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>
                        </div>
                        <div class="mb-2">
                            <span class="bg-slate-100 dark:bg-slate-900 text-slate-500 dark:text-slate-400 text-[9px] font-bold px-1.5 py-0.5 rounded mr-2">${idx + 1}</span>
                            <div class="inline-block">
                                <div class="text-[10px] font-bold uppercase ${theme.color}">${item.degree}º Modo <span class="text-slate-400 dark:text-slate-500 font-normal normal-case">de</span></div>
                                <div class="text-[10px] ${theme.color} opacity-80 leading-none">${item.family}</div>
                            </div>
                        </div>
                        <div class="text-2xl font-black text-slate-900 dark:text-white mb-1">${item.chord}</div>
                        <div class="text-[10px] text-slate-500 dark:text-slate-400 mb-3 font-medium tracking-wide truncate" title="${item.mode}">${item.mode}</div>
                        <div class="flex flex-wrap gap-1">${notesHTML}</div>
                    `;
                    container.appendChild(div);
                });
            } else {
                clearBtn.classList.add('hidden');
                container.innerHTML = `
                    <div class="w-full text-center py-8 text-slate-400 dark:text-slate-600 border-2 border-dashed border-slate-200 dark:border-slate-800 rounded-xl">
                        <p class="text-sm">No has agregado acordes aún.</p>
                        <p class="text-xs mt-1">Usa el botón "+" en el centro o en el inspector.</p>
                    </div>`;
            }
            lucide.createIcons();
        }

        function addToProgression(data) {
            const details = getStrictScaleDetails(data.root, data.intervals);
            state.progression.push({
                id: Date.now(),
                root: data.root,
                mode: data.mode,
                chord: data.chord,
                family: data.family,
                degree: data.degree,
                notes: details.notes,
                intervals: data.intervals
            });
            renderProgression();
            playChord(data.root, data.intervals);
            const c = document.getElementById('progression-container');
            setTimeout(() => c.scrollLeft = c.scrollWidth, 100);
        }

        function removeProgressionItem(id) {
            state.progression = state.progression.filter(p => p.id !== id);
            renderProgression();
        }

        function clearProgression() {
            if (state.clearConfirm) {
                state.progression = [];
                state.clearConfirm = false;
                renderProgression();
            } else {
                state.clearConfirm = true;
                renderProgression();
                setTimeout(() => { state.clearConfirm = false; renderProgression(); }, 3000);
            }
        }

        // --- ACTION HANDLERS (Global scope) ---
        window.addHomeToProgression = () => {
            const rootIdx = getNoteIndex(state.root);
            const mode = ALL_MODES_FLAT[state.mode];
            const chord = getChordSymbol(state.root, mode.intervals);
            addToProgression({ ...mode, root: state.root, mode: state.mode, chord });
        };
        
        window.playHome = () => {
            const mode = ALL_MODES_FLAT[state.mode];
            playChord(state.root, mode.intervals);
        };

        window.addInspectorToProgression = () => {
            if(state.hoveredNode) addToProgression(state.hoveredNode);
        };
        
        window.goToInspector = () => {
            if(state.hoveredNode) {
                state.root = state.hoveredNode.root;
                state.mode = state.hoveredNode.mode;
                state.hoveredNode = null;
                document.getElementById('root-select').value = state.root;
                document.getElementById('mode-select').value = state.mode;
                update();
            }
        };

        window.playInspector = (type) => {
            if(state.hoveredNode) playChord(state.hoveredNode.root, state.hoveredNode.intervals, type);
        };

        window.playProgressionItem = (id) => {
            const item = state.progression.find(p => p.id === id);
            if(item) playChord(item.root, item.intervals);
        };

        window.removeProgressionItem = removeProgressionItem;
        window.toggleEnharmonicInspector = toggleEnharmonicInspector;

        // Start
        init();

    </script>
</body>
</html>
